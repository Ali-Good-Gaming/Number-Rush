<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NUMBER RUSH - Arcade Puzzle</title>
    <!-- Подключаем пиксельный шрифт -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-red: #ff0055;
            --neon-cyan: #00ffff;
            --neon-yellow: #ffff00;
            --neon-green: #39ff14;
            --bg-color: #050510;
            --scanline-color: rgba(18, 16, 16, 0.5);
            --crt-flicker: rgba(255, 255, 255, 0.02);
            --text-shadow: 2px 2px 0px #000;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            color: var(--neon-cyan);
            font-family: 'Press Start 2P', cursive;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- Фон --- */
        #bg-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        /* --- CRT Эффекты --- */
        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            background: transparent;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .crt-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                rgba(255, 255, 255, 0),
                rgba(255, 255, 255, 0) 50%,
                rgba(0, 0, 0, 0.2) 50%,
                rgba(0, 0, 0, 0.2)
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 100;
            animation: flicker 0.15s infinite;
        }

        .crt-overlay::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: radial-gradient(circle, rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.4) 100%);
            z-index: 101;
        }

        @keyframes flicker {
            0% { opacity: 0.9; }
            50% { opacity: 1.0; }
            100% { opacity: 0.9; }
        }

        /* --- UI Элементы --- */
        .screen {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
            padding: 20px;
            transition: opacity 0.3s;
            overflow-y: auto; /* Для скролла правил */
        }

        .screen.active {
            display: flex;
        }

        h1 {
            font-size: 2.5rem;
            color: var(--neon-yellow);
            text-shadow: 4px 4px var(--neon-red);
            text-align: center;
            line-height: 1.5;
            margin-bottom: 30px;
            animation: pulse 2s infinite;
        }

        .btn {
            background: transparent;
            border: 4px solid var(--neon-cyan);
            color: var(--neon-cyan);
            font-family: 'Press Start 2P', cursive;
            font-size: 1rem;
            padding: 15px 25px;
            margin: 10px;
            cursor: pointer;
            text-shadow: var(--text-shadow);
            box-shadow: 0 0 10px var(--neon-cyan);
            transition: transform 0.1s, box-shadow 0.2s, background 0.2s;
            text-transform: uppercase;
            width: 80%;
            max-width: 350px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
        }

        .btn:active {
            transform: scale(0.95);
            background: var(--neon-cyan);
            color: #000;
        }

        .btn:hover {
            box-shadow: 0 0 20px var(--neon-cyan);
        }

        .btn-red {
            border-color: var(--neon-red);
            color: var(--neon-red);
            box-shadow: 0 0 10px var(--neon-red);
        }
        .btn-red:hover { box-shadow: 0 0 20px var(--neon-red); }
        .btn-red:active { background: var(--neon-red); color: white;}

        /* --- Игровой HUD --- */
        #game-screen {
            justify-content: space-between;
            padding-bottom: 40px;
        }

        .hud-top {
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 10px;
            font-size: 0.7rem;
            color: var(--neon-yellow);
            text-shadow: 1px 1px 0 #000;
        }

        .main-display {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        #target-display {
            font-size: 5rem;
            color: white;
            text-shadow: 0 0 20px var(--neon-cyan);
            margin: 20px 0;
            transition: color 0.3s;
        }
        
        #hint-text {
            font-size: 1rem;
            margin-top: 10px;
            height: 20px;
            color: var(--neon-green);
            text-align: center;
        }

        #feedback-bg {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 300px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(0,255,255,0.2) 0%, rgba(0,0,0,0) 70%);
            z-index: -1;
            transition: background 0.5s ease;
        }

        /* --- Управление --- */
        .controls-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            width: 100%;
        }

        .control-row {
            display: flex;
            gap: 20px;
            justify-content: center;
            width: 100%;
        }

        .ctrl-btn {
            width: 70px;
            height: 70px;
            border: 3px solid white;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1.2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Press Start 2P';
            box-shadow: 0 4px 0 #666;
            border-radius: 8px;
            transition: all 0.1s;
        }

        .ctrl-btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #666;
            background: rgba(255,255,255,0.3);
        }

        /* --- Настройки и Соц. сети --- */
        .toggle-switch, .volume-control {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 80%;
            max-width: 350px;
            margin: 15px 0;
            color: var(--neon-cyan);
            font-size: 0.8rem;
        }

        input[type=range] {
            -webkit-appearance: none;
            width: 50%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            background: var(--neon-cyan);
            margin-top: -8px;
            box-shadow: 0 0 10px var(--neon-cyan);
            cursor: pointer;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #333;
            border: 1px solid #555;
        }

        .social-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
            width: 100%;
        }
        
        .social-icon {
            width: 40px;
            height: 40px;
            fill: var(--neon-cyan);
            filter: drop-shadow(0 0 5px var(--neon-cyan));
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .social-icon:hover {
            transform: scale(1.2);
            fill: var(--neon-yellow);
            filter: drop-shadow(0 0 10px var(--neon-yellow));
        }

        /* --- Правила --- */
        .rules-content {
            font-size: 0.7rem;
            line-height: 1.6;
            color: white;
            text-align: left;
            width: 90%;
            max-width: 500px;
            background: rgba(0,0,0,0.5);
            padding: 20px;
            border: 1px solid var(--neon-cyan);
            margin-bottom: 20px;
        }

        .rules-content h3 {
            color: var(--neon-yellow);
            margin-top: 15px;
            margin-bottom: 5px;
            border-bottom: 1px dashed var(--neon-red);
        }

        /* --- Анимации --- */
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .glitch-effect {
            animation: glitch 0.3s linear infinite;
        }

        @keyframes glitch {
            0% { transform: translate(0) }
            20% { transform: translate(-2px, 2px) }
            40% { transform: translate(-2px, -2px) }
            60% { transform: translate(2px, 2px) }
            80% { transform: translate(2px, -2px) }
            100% { transform: translate(0) }
        }

        /* --- Ландшафтный режим --- */
        @media (orientation: landscape) and (max-height: 600px) {
            #game-screen {
                flex-direction: row;
                align-items: center;
                padding: 10px 40px;
            }
            .hud-top {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
            }
            .controls-area {
                width: auto;
                flex-direction: row;
            }
            .control-row {
                flex-direction: column;
                gap: 10px;
            }
            .screen {
                padding-top: 60px; /* Space for scrolling content */
            }
        }

        /* --- Частицы --- */
        .particle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: white;
            pointer-events: none;
            z-index: 50;
        }

        /* High Score Table */
        .score-row {
            display: flex;
            justify-content: space-between;
            width: 80%;
            max-width: 400px;
            margin: 5px 0;
            color: var(--neon-cyan);
            font-size: 0.8rem;
            border-bottom: 1px dashed #333;
            padding-bottom: 5px;
        }
    </style>
</head>
<body>

    <!-- Фон Canvas -->
    <canvas id="bg-canvas"></canvas>

    <div id="game-container">
        <div class="crt-overlay"></div>

        <!-- SPLASH SCREEN -->
        <div id="splash-screen" class="screen active" onclick="game.initAudio(); game.showScreen('menu');">
            <h1>NUMBER<br>RUSH</h1>
            <p style="animation: pulse 1s infinite; margin-top: 50px; font-size: 0.8rem;" data-i18n="tapToStart">НАЖМИ ДЛЯ СТАРТА</p>
        </div>

        <!-- MENU SCREEN -->
        <div id="menu-screen" class="screen">
            <h1>NUMBER RUSH</h1>
            <button class="btn" onclick="game.showScreen('mode-select')" data-i18n="play">ИГРАТЬ</button>
            <button class="btn" onclick="game.showHighScores()" data-i18n="scores">РЕКОРДЫ</button>
            <button class="btn" onclick="game.showScreen('settings')" data-i18n="settings">НАСТРОЙКИ</button>
        </div>

        <!-- SETTINGS SCREEN -->
        <div id="settings-screen" class="screen">
            <h2 style="color: var(--neon-cyan)" data-i18n="settings">НАСТРОЙКИ</h2>
            
            <div class="toggle-switch">
                <span data-i18n="language">ЯЗЫК / LANG</span>
                <button class="btn" style="width: auto; padding: 10px;" onclick="game.toggleLanguage()" id="lang-btn">RU</button>
            </div>

            <div class="volume-control">
                <span data-i18n="volume">ГРОМКОСТЬ</span>
                <input type="range" min="0" max="100" value="50" oninput="game.setVolume(this.value)">
            </div>

            <button class="btn" onclick="game.showScreen('rules')" data-i18n="howToPlay">КАК ИГРАТЬ</button>

            <!-- Social Media Icons -->
            <div class="social-links">
                <a href="https://youtube.com/@ali-gg?si=ua0XEhBtC0Pw5x7D" target="_blank" title="YouTube">
                    <svg class="social-icon" viewBox="0 0 24 24">
                        <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                    </svg>
                </a>
                <a href="https://t.me/aligoodgaming" target="_blank" title="Telegram">
                    <svg class="social-icon" viewBox="0 0 24 24">
                        <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 11.944 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
                    </svg>
                </a>
                <a href="https://www.tiktok.com/@ali_goodgaming?_r=1&_t=ZS-92vefrVyLnp" target="_blank" title="TikTok">
                    <svg class="social-icon" viewBox="0 0 24 24">
                        <path d="M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.05-2.89-.35-4.2-.97-.57-.26-1.1-.59-1.62-.93v6.16c0 3.48-2.3 6.31-5.64 6.95-3.42.66-7.05-1.28-7.95-4.66-.75-2.83.6-5.83 3.22-7.15.54-.27 1.11-.47 1.69-.6V13.1c-.88.16-1.77.67-2.37 1.4-.87 1.04-.98 2.68-.11 3.73.72.87 2.21 1.25 3.19.79 1.35-.63 2.05-2.14 1.95-3.61V.02h2z"/>
                    </svg>
                </a>
            </div>

            <button class="btn" onclick="game.showScreen('menu')" style="margin-top: 30px;" data-i18n="back">НАЗАД</button>
        </div>

        <!-- RULES SCREEN -->
        <div id="rules-screen" class="screen">
            <h2 style="color: var(--neon-green); margin-bottom: 20px;" data-i18n="howToPlay">КАК ИГРАТЬ</h2>
            
            <div class="rules-content">
                <h3 data-i18n="basics">ОСНОВЫ</h3>
                <p data-i18n="rulesBasics">Используйте кнопки +/- чтобы найти загаданное число. Смотрите на цвет фона: СИНИЙ - холодно, КРАСНЫЙ - горячо!</p>
                
                <h3 data-i18n="modes">РЕЖИМЫ</h3>
                <p><strong style="color:var(--neon-cyan)">CLASSIC:</strong> 10 попыток найти число от 1 до 100.</p>
                <p><strong style="color:var(--neon-yellow)">TIME ATTACK:</strong> 60 секунд. Угадай число чтобы получить +5 секунд.</p>
                <p><strong style="color:var(--neon-red)">CHAOS:</strong> Осторожно! Кнопки могут меняться местами, а подсказки врать.</p>
                
                <h3>SOCIAL</h3>
                <p>Ali GG</p>
            </div>

            <button class="btn" onclick="game.showScreen('settings')" data-i18n="back">НАЗАД</button>
        </div>

        <!-- MODE SELECT -->
        <div id="mode-select-screen" class="screen">
            <h2 style="color: var(--neon-cyan); margin-bottom: 30px;" data-i18n="modeSelect">ВЫБОР РЕЖИМА</h2>
            <button class="btn" onclick="game.startGame('classic')" data-i18n="classic">КЛАССИКА</button>
            <button class="btn" onclick="game.startGame('time')" data-i18n="timeAttack">НА ВРЕМЯ</button>
            <button class="btn btn-red" onclick="game.startGame('chaos')" data-i18n="chaos">ХАОС</button>
            <button class="btn" onclick="game.showScreen('menu')" style="margin-top: 20px; border: none; font-size: 0.7rem;" data-i18n="back">&lt; НАЗАД</button>
        </div>

        <!-- GAME SCREEN -->
        <div id="game-screen" class="screen">
            <div class="hud-top">
                <span id="hud-mode">CLASSIC</span>
                <span id="hud-score">СЧЁТ: 0</span>
                <span id="hud-info">ПОПЫТКИ: 10</span>
                <div id="pause-btn" style="cursor: pointer;" onclick="game.togglePause()">II</div>
            </div>

            <div class="main-display">
                <div id="feedback-bg"></div>
                <div id="target-display">50</div>
                <div id="hint-text">START!</div>
                <div id="combo-display" style="color: var(--neon-yellow); font-size: 0.8rem; height: 15px; margin-top: 5px;"></div>
            </div>

            <div class="controls-area" id="controls">
                <div class="control-row">
                    <button class="ctrl-btn" data-val="-5" onclick="game.updateValue(-5)">-5</button>
                    <button class="ctrl-btn" data-val="-1" onclick="game.updateValue(-1)">-1</button>
                </div>
                <div class="control-row">
                    <button class="ctrl-btn" data-val="1" onclick="game.updateValue(1)">+1</button>
                    <button class="ctrl-btn" data-val="5" onclick="game.updateValue(5)">+5</button>
                </div>
                <button class="btn btn-red" style="width: auto; padding: 10px 30px; margin-top: 10px;" onclick="game.submitGuess()">OK</button>
            </div>
        </div>

        <!-- PAUSE SCREEN -->
        <div id="pause-screen" class="screen" style="background: rgba(0,0,0,0.9);">
            <h2 style="color: var(--neon-yellow)" data-i18n="paused">ПАУЗА</h2>
            <button class="btn" onclick="game.togglePause()" data-i18n="resume">ПРОДОЛЖИТЬ</button>
            <button class="btn" onclick="game.quitGame()" data-i18n="menu">МЕНЮ</button>
        </div>

        <!-- RESULT SCREEN -->
        <div id="result-screen" class="screen">
            <h1 id="result-title">VICTORY</h1>
            <p id="result-msg" style="color: white; margin-bottom: 20px; text-align: center; line-height: 1.5;"></p>
            <p id="result-score" style="color: var(--neon-yellow); font-size: 1.5rem; margin-bottom: 30px;">0</p>
            <button class="btn" onclick="game.restartGame()" data-i18n="replay">ЗАНОВО</button>
            <button class="btn" onclick="game.showScreen('menu')" data-i18n="menu">МЕНЮ</button>
        </div>

        <!-- SCORES SCREEN -->
        <div id="scores-screen" class="screen">
            <h2 data-i18n="scores">РЕКОРДЫ</h2>
            <div id="scores-list" style="width: 100%; display: flex; flex-direction: column; align-items: center; margin-bottom: 20px;">
                <!-- JS Populated -->
            </div>
            <button class="btn" onclick="game.showScreen('menu')" data-i18n="back">НАЗАД</button>
        </div>
    </div>

    <script>
        /**
         * LOCALIZATION & TEXT DATA
         */
        const TRANSLATIONS = {
            ru: {
                tapToStart: "НАЖМИ ДЛЯ СТАРТА",
                play: "ИГРАТЬ",
                scores: "РЕКОРДЫ",
                settings: "НАСТРОЙКИ",
                back: "НАЗАД",
                modeSelect: "ВЫБОР РЕЖИМА",
                classic: "КЛАССИКА",
                timeAttack: "НА ВРЕМЯ",
                chaos: "ХАОС",
                score: "СЧЁТ",
                attempts: "ПОПЫТКИ",
                timeLeft: "ВРЕМЯ",
                language: "ЯЗЫК",
                paused: "ПАУЗА",
                resume: "ПРОДОЛЖИТЬ",
                menu: "МЕНЮ",
                victory: "ПОБЕДА",
                missionComplete: "МИССИЯ ВЫПОЛНЕНА",
                gameOver: "ИГРА ОКОНЧЕНА",
                replay: "ЗАНОВО",
                higher: "БОЛЬШЕ ▲",
                lower: "МЕНЬШЕ ▼",
                perfect: "ОТЛИЧНО!",
                chaosCleared: "ХАОС ПРОЙДЕН!",
                newRecord: "НОВЫЙ РЕКОРД!",
                targetWas: "Число было",
                start: "СТАРТ!",
                guess: "ЖМИ!",
                tryAgain: "Попробуй еще!",
                amazing: "ВЕЛИКОЛЕПНО!",
                finalScore: "Финальный счёт",
                volume: "ГРОМКОСТЬ",
                howToPlay: "КАК ИГРАТЬ",
                basics: "ОСНОВЫ",
                modes: "РЕЖИМЫ",
                rulesBasics: "Используйте кнопки +/- чтобы найти загаданное число. Смотрите на цвет фона: СИНИЙ - холодно, КРАСНЫЙ - горячо!"
            },
            en: {
                tapToStart: "TAP TO START",
                play: "PLAY",
                scores: "SCORES",
                settings: "SETTINGS",
                back: "BACK",
                modeSelect: "SELECT MODE",
                classic: "CLASSIC",
                timeAttack: "TIME ATTACK",
                chaos: "CHAOS",
                score: "SCORE",
                attempts: "TRIES",
                timeLeft: "TIME",
                language: "LANGUAGE",
                paused: "PAUSED",
                resume: "RESUME",
                menu: "MENU",
                victory: "VICTORY",
                missionComplete: "MISSION COMPLETE",
                gameOver: "GAME OVER",
                replay: "REPLAY",
                higher: "HIGHER ▲",
                lower: "LOWER ▼",
                perfect: "PERFECT!",
                chaosCleared: "CHAOS CLEARED!",
                newRecord: "NEW RECORD!",
                targetWas: "The number was",
                start: "START!",
                guess: "GUESS!",
                tryAgain: "Try again!",
                amazing: "AMAZING!",
                finalScore: "Final Score",
                volume: "VOLUME",
                howToPlay: "HOW TO PLAY",
                basics: "BASICS",
                modes: "MODES",
                rulesBasics: "Use +/- buttons to find the secret number. Watch background color: BLUE is cold, RED is hot!"
            }
        };

        /**
         * INTERACTIVE BACKGROUND
         */
        class BackgroundController {
            constructor() {
                this.canvas = document.getElementById('bg-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.particles = [];
                this.width = window.innerWidth;
                this.height = window.innerHeight;
                this.mouseX = this.width / 2;
                this.mouseY = this.height / 2;
                
                this.speedMultiplier = 1;
                this.isChaos = false;

                window.addEventListener('resize', () => this.resize());
                document.addEventListener('mousemove', (e) => {
                    this.mouseX = e.clientX;
                    this.mouseY = e.clientY;
                });
                // Touch handling
                document.addEventListener('touchmove', (e) => {
                    this.mouseX = e.touches[0].clientX;
                    this.mouseY = e.touches[0].clientY;
                });

                this.resize();
                this.createParticles();
                this.animate();
            }

            resize() {
                this.width = window.innerWidth;
                this.height = window.innerHeight;
                this.canvas.width = this.width;
                this.canvas.height = this.height;
            }

            createParticles() {
                this.particles = [];
                const count = this.width < 600 ? 50 : 100;
                for (let i = 0; i < count; i++) {
                    this.particles.push({
                        x: Math.random() * this.width,
                        y: Math.random() * this.height,
                        z: Math.random() * 2 + 1, // depth/speed
                        size: Math.random() * 2 + 1,
                        color: Math.random() > 0.5 ? '#00ffff' : '#ff0055'
                    });
                }
            }

            setMode(mode) {
                if (mode === 'chaos') {
                    this.isChaos = true;
                    this.speedMultiplier = 3;
                } else if (mode === 'time') {
                    this.isChaos = false;
                    this.speedMultiplier = 2;
                } else {
                    this.isChaos = false;
                    this.speedMultiplier = 0.5; // Calm for classic/menu
                }
            }

            animate() {
                this.ctx.fillStyle = '#050510'; // BG Clear color
                this.ctx.fillRect(0, 0, this.width, this.height);

                // Mouse interaction offset
                const dx = (this.mouseX - this.width / 2) * 0.05;
                const dy = (this.mouseY - this.height / 2) * 0.05;

                this.particles.forEach(p => {
                    // Move
                    p.y += p.z * this.speedMultiplier;
                    
                    // Chaos jitter
                    let jitterX = 0;
                    if (this.isChaos) jitterX = (Math.random() - 0.5) * 4;

                    // Draw
                    this.ctx.fillStyle = p.color;
                    this.ctx.globalAlpha = (p.z / 3) * 0.6; // Further is dimmer
                    this.ctx.beginPath();
                    this.ctx.rect(p.x - dx + jitterX, p.y - dy, p.size, p.size); // Pixel square
                    this.ctx.fill();

                    // Reset if out of bounds
                    if (p.y > this.height) {
                        p.y = -10;
                        p.x = Math.random() * this.width;
                    }
                });

                requestAnimationFrame(() => this.animate());
            }
        }

        /**
         * AUDIO SYSTEM
         */
        class AudioController {
            constructor() {
                this.ctx = null;
                this.enabled = true;
                this.masterGain = 0.5;
            }

            init() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (this.ctx.state === 'suspended') {
                    this.ctx.resume();
                }
            }
            
            setVolume(val) {
                this.masterGain = val / 100;
            }

            playTone(freq, type, duration, vol = 0.1) {
                if (!this.enabled || !this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                
                // Apply master volume
                const finalVol = vol * this.masterGain;
                
                gain.gain.setValueAtTime(finalVol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);

                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            }

            playClick() { this.playTone(800, 'square', 0.05, 0.05); }
            playBuzz() { this.playTone(150, 'sawtooth', 0.3, 0.1); }
            playPing() { this.playTone(1200, 'sine', 0.1, 0.1); }
            
            playWin() {
                if (!this.enabled || !this.ctx) return;
                [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
                    setTimeout(() => this.playTone(freq, 'square', 0.2, 0.1), i * 100);
                });
            }

            playHotCold(distance, maxDist) {
                const normalized = 1 - Math.min(distance / maxDist, 1);
                const freq = 200 + (normalized * 1000);
                this.playTone(freq, 'triangle', 0.15, 0.08);
            }
        }

        /**
         * GAME LOGIC
         */
        class Game {
            constructor() {
                this.audio = new AudioController();
                this.bg = new BackgroundController();
                this.state = 'splash'; 
                this.mode = 'classic';
                this.lang = 'ru'; // Default Language
                
                this.targetNumber = 0;
                this.currentGuess = 50;
                this.score = 0;
                this.attempts = 0;
                this.timeLeft = 0;
                this.combo = 1;
                this.lastActionTime = 0;
                this.timerInterval = null;
                
                this.isChaos = false;
                
                // UI Elements refs
                this.ui = {
                    screens: document.querySelectorAll('.screen'),
                    targetDisplay: document.getElementById('target-display'),
                    feedbackBg: document.getElementById('feedback-bg'),
                    hintText: document.getElementById('hint-text'),
                    hudMode: document.getElementById('hud-mode'),
                    hudScore: document.getElementById('hud-score'),
                    hudInfo: document.getElementById('hud-info'),
                    combo: document.getElementById('combo-display'),
                    controls: document.getElementById('controls'),
                    langBtn: document.getElementById('lang-btn')
                };

                this.bindControls();
                this.applyLanguage(); // Init Text
            }

            // --- LOCALIZATION ---

            t(key) {
                return TRANSLATIONS[this.lang][key] || key;
            }

            toggleLanguage() {
                this.lang = this.lang === 'ru' ? 'en' : 'ru';
                this.ui.langBtn.innerText = this.lang.toUpperCase();
                this.applyLanguage();
            }

            applyLanguage() {
                // Update all elements with data-i18n
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    el.innerText = this.t(key);
                });
                // Update Dynamic HUD if in game
                if (this.state === 'playing') this.updateHUD();
            }

            // --- SYSTEM ---

            initAudio() {
                this.audio.init();
            }
            
            setVolume(val) {
                this.audio.setVolume(val);
            }

            showScreen(id) {
                this.ui.screens.forEach(s => s.classList.remove('active'));
                document.getElementById(id + '-screen').classList.add('active');
                this.state = id === 'game' ? 'playing' : id;

                // Adjust BG based on screen
                if (id === 'menu' || id === 'splash' || id === 'settings') {
                    this.bg.setMode('menu');
                }
            }

            // --- GAME LOOP ---

            startGame(mode) {
                this.mode = mode;
                this.score = 0;
                this.combo = 1;
                this.isChaos = (mode === 'chaos');
                
                // Reset Visuals
                document.body.classList.remove('glitch-effect');
                this.ui.controls.style.transform = 'none';

                this.bg.setMode(mode);

                if (mode === 'classic') {
                    this.setupRoundClassic();
                } else if (mode === 'time') {
                    this.timeLeft = 60;
                    this.setupRoundTime();
                    this.startTimer();
                } else if (mode === 'chaos') {
                    this.setupRoundChaos();
                }

                this.showScreen('game');
                this.updateHUD();
            }

            setupRoundClassic() {
                this.targetNumber = Math.floor(Math.random() * 100) + 1;
                this.currentGuess = 50;
                this.attempts = 10;
                this.resetFeedback();
            }

            setupRoundTime() {
                const range = 100 + Math.floor(this.score / 500) * 50; 
                this.targetNumber = Math.floor(Math.random() * range) + 1;
                this.currentGuess = Math.floor(range / 2);
                this.resetFeedback();
            }

            setupRoundChaos() {
                const max = 50 + Math.floor(Math.random() * 150);
                this.targetNumber = Math.floor(Math.random() * max) + 1;
                this.currentGuess = Math.floor(max / 2);
                this.attempts = 8;
                
                if (Math.random() > 0.5) {
                    this.ui.controls.style.flexDirection = 'column-reverse';
                } else {
                    this.ui.controls.style.flexDirection = 'column';
                }
                
                this.resetFeedback();
            }

            resetFeedback() {
                this.ui.targetDisplay.innerText = this.currentGuess;
                this.ui.feedbackBg.style.background = `radial-gradient(circle, rgba(0,255,255,0.2) 0%, rgba(0,0,0,0) 70%)`;
                this.ui.hintText.innerText = this.t('guess');
                this.ui.hintText.style.color = "var(--neon-cyan)";
                this.ui.targetDisplay.style.color = "white";
            }

            startTimer() {
                if (this.timerInterval) clearInterval(this.timerInterval);
                this.timerInterval = setInterval(() => {
                    if (this.state !== 'playing') return;
                    this.timeLeft--;
                    this.updateHUD();
                    if (this.timeLeft <= 0) {
                        this.gameOver(false);
                    }
                }, 1000);
            }

            // --- INPUT ---

            updateValue(delta) {
                if (this.state !== 'playing') return;

                if (this.isChaos && Math.random() < 0.1) {
                    delta = -delta;
                    this.triggerGlitch();
                }

                this.currentGuess += delta;
                if (this.currentGuess < 0) this.currentGuess = 0;
                
                this.audio.playClick();
                this.ui.targetDisplay.innerText = this.currentGuess;
                this.checkProximity();
            }

            checkProximity() {
                const diff = Math.abs(this.targetNumber - this.currentGuess);
                let color = "rgba(0, 255, 255, 0.2)"; 
                let textColor = "white";

                if (diff === 0) {
                    color = "rgba(57, 255, 20, 0.6)"; 
                    textColor = "var(--neon-green)";
                } else if (diff < 5) {
                    color = "rgba(255, 0, 0, 0.5)"; 
                    textColor = "var(--neon-red)";
                } else if (diff < 15) {
                    color = "rgba(255, 0, 85, 0.4)"; 
                    textColor = "#ff00aa";
                } else if (diff < 30) {
                    color = "rgba(100, 0, 255, 0.3)"; 
                }

                this.ui.feedbackBg.style.background = `radial-gradient(circle, ${color} 0%, rgba(0,0,0,0) 70%)`;
                this.ui.targetDisplay.style.color = textColor;
                this.audio.playHotCold(diff, 100);
            }

            submitGuess() {
                if (this.state !== 'playing') return;

                const diff = this.targetNumber - this.currentGuess;
                const now = Date.now();
                if (now - this.lastActionTime < 1500) {
                    this.combo = Math.min(this.combo + 0.5, 5.0); 
                } else {
                    this.combo = 1;
                }
                this.lastActionTime = now;

                if (diff === 0) {
                    this.handleWin();
                } else {
                    this.handleMiss(diff);
                }
            }

            handleWin() {
                this.audio.playWin();
                this.createParticles();
                
                const points = Math.ceil(100 * this.combo * (this.isChaos ? 3 : 1));
                this.score += points;

                if (this.mode === 'classic') {
                    this.score += (this.attempts * 10);
                    this.gameOver(true);
                } else if (this.mode === 'time') {
                    this.timeLeft += 5;
                    this.showFloatingText(this.t('perfect') + " +5s");
                    this.setupRoundTime();
                } else if (this.mode === 'chaos') {
                    this.showFloatingText(this.t('chaosCleared'));
                    this.setupRoundChaos();
                }
                this.updateHUD();
            }

            handleMiss(diff) {
                this.combo = 1; 
                this.audio.playBuzz();
                this.triggerShake();
                
                if (navigator.vibrate) navigator.vibrate(200);

                let msg = diff > 0 ? this.t('higher') : this.t('lower');
                
                if (this.isChaos && Math.random() < 0.2) {
                    msg = diff > 0 ? this.t('lower') : this.t('higher'); // Lie
                    this.ui.hintText.style.color = "var(--neon-red)";
                    this.triggerGlitch();
                } else {
                    this.ui.hintText.style.color = "var(--neon-cyan)";
                }

                this.ui.hintText.innerText = msg;

                if (this.mode === 'classic' || this.mode === 'chaos') {
                    this.attempts--;
                    if (this.attempts <= 0) {
                        this.gameOver(false);
                    }
                }
                
                this.updateHUD();
            }

            gameOver(win) {
                this.state = 'result';
                this.bg.setMode('menu'); // Calm BG
                clearInterval(this.timerInterval);
                
                const title = win ? this.t('missionComplete') : this.t('gameOver');
                const msg = win 
                    ? `${this.t('amazing')}\n${this.t('finalScore')}: ${this.score}` 
                    : `${this.t('targetWas')} ${this.targetNumber}.\n${this.t('tryAgain')}`;
                
                document.getElementById('result-title').innerText = title;
                document.getElementById('result-title').style.color = win ? "var(--neon-green)" : "var(--neon-red)";
                document.getElementById('result-msg').innerText = msg;
                document.getElementById('result-score').innerText = this.score;

                this.saveScore();
                this.showScreen('result');
            }

            saveScore() {
                const key = `numberRush_${this.mode}`;
                const saved = parseInt(localStorage.getItem(key) || '0');
                if (this.score > saved) {
                    localStorage.setItem(key, this.score);
                    document.getElementById('result-msg').innerText += `\n${this.t('newRecord')}`;
                }
            }

            showHighScores() {
                const list = document.getElementById('scores-list');
                list.innerHTML = '';
                ['classic', 'time', 'chaos'].forEach(m => {
                    const s = localStorage.getItem(`numberRush_${m}`) || 0;
                    // Translate mode name specifically for table
                    let modeName = m === 'classic' ? 'classic' : (m === 'time' ? 'timeAttack' : 'chaos');
                    
                    list.innerHTML += `
                        <div class="score-row">
                            <span>${this.t(modeName)}</span>
                            <span>${s}</span>
                        </div>
                    `;
                });
                this.showScreen('scores');
            }

            togglePause() {
                if (this.state === 'playing') {
                    this.state = 'paused';
                    clearInterval(this.timerInterval);
                    document.getElementById('pause-screen').classList.add('active');
                } else if (this.state === 'paused') {
                    this.state = 'playing';
                    if (this.mode === 'time') this.startTimer();
                    document.getElementById('pause-screen').classList.remove('active');
                }
            }

            quitGame() {
                document.getElementById('pause-screen').classList.remove('active');
                this.showScreen('menu');
            }

            restartGame() {
                this.startGame(this.mode);
            }

            updateHUD() {
                // Determine mode name translation key
                let modeKey = this.mode === 'classic' ? 'classic' : (this.mode === 'time' ? 'timeAttack' : 'chaos');
                
                this.ui.hudMode.innerText = this.t(modeKey);
                this.ui.hudScore.innerText = `${this.t('score')}: ${this.score}`;
                this.ui.combo.innerText = this.combo > 1 ? `COMBO x${this.combo}` : "";
                
                if (this.mode === 'time') {
                    this.ui.hudInfo.innerText = `${this.t('timeLeft')}: ${this.timeLeft}`;
                    this.ui.hudInfo.style.color = this.timeLeft < 10 ? "var(--neon-red)" : "var(--neon-yellow)";
                } else {
                    this.ui.hudInfo.innerText = `${this.t('attempts')}: ${this.attempts}`;
                }
            }

            // --- EFFECTS ---

            triggerShake() {
                this.ui.targetDisplay.classList.remove('shake');
                void this.ui.targetDisplay.offsetWidth; // reflow
                this.ui.targetDisplay.classList.add('shake');
            }

            triggerGlitch() {
                document.body.classList.add('glitch-effect');
                setTimeout(() => document.body.classList.remove('glitch-effect'), 200);
            }

            createParticles() {
                const rect = this.ui.targetDisplay.getBoundingClientRect();
                const center = { x: rect.left + rect.width/2, y: rect.top + rect.height/2 };
                
                for(let i=0; i<20; i++) {
                    const p = document.createElement('div');
                    p.classList.add('particle');
                    document.body.appendChild(p);
                    
                    const angle = Math.random() * Math.PI * 2;
                    const velocity = 2 + Math.random() * 5;
                    const dx = Math.cos(angle) * velocity;
                    const dy = Math.sin(angle) * velocity;
                    
                    let x = center.x;
                    let y = center.y;
                    let life = 1.0;
                    
                    const anim = () => {
                        x += dx;
                        y += dy;
                        life -= 0.05;
                        p.style.transform = `translate(${x}px, ${y}px)`;
                        p.style.opacity = life;
                        p.style.background = `hsl(${Math.random()*360}, 100%, 50%)`;
                        
                        if (life > 0) requestAnimationFrame(anim);
                        else p.remove();
                    };
                    anim();
                }
            }
            
            showFloatingText(text) {
                const el = document.createElement('div');
                el.innerText = text;
                el.style.position = 'absolute';
                el.style.top = '50%';
                el.style.left = '50%';
                el.style.transform = 'translate(-50%, -50%)';
                el.style.color = 'white';
                el.style.textShadow = '0 0 5px var(--neon-cyan)';
                el.style.fontSize = '1.5rem';
                el.style.pointerEvents = 'none';
                el.style.transition = 'all 1s ease-out';
                el.style.zIndex = 100;
                document.body.appendChild(el);
                
                requestAnimationFrame(() => {
                    el.style.top = '20%';
                    el.style.opacity = 0;
                });
                
                setTimeout(() => el.remove(), 1000);
            }

            bindControls() {
                // Keyboard
                document.addEventListener('keydown', (e) => {
                    if (this.state !== 'playing') return;
                    
                    switch(e.key) {
                        case 'ArrowUp': this.updateValue(1); break;
                        case 'ArrowDown': this.updateValue(-1); break;
                        case 'ArrowRight': this.updateValue(5); break;
                        case 'ArrowLeft': this.updateValue(-5); break;
                        case 'Enter': case ' ': this.submitGuess(); break;
                        case 'Escape': this.togglePause(); break;
                    }
                });
            }
        }

        // Init Game
        const game = new Game();

    </script>
</body>
</html>
